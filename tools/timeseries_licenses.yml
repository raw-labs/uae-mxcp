mxcp: 1.0.0
tool:
  name: timeseries_licenses
  description: Analyze licenses trends over time
  parameters:
  - name: timeField
    type: string
    description: Date field to analyze
    enum:
    - bl_est_date
    - bl_exp_date
    - bl_est_date_d
    - bl_exp_date_d
    default: bl_est_date
  - name: granularity
    type: string
    description: Time granularity
    enum:
    - day
    - week
    - month
    - quarter
    - year
    default: month
  - name: startDate
    type: string
    format: date
    description: Start date (YYYY-MM-DD)
    default: null
  - name: endDate
    type: string
    format: date
    description: End date (YYYY-MM-DD)
    default: null
  return:
    type: array
    items:
      type: object
      properties:
        period:
          type: string
          format: date
        count:
          type: integer
        unique_licenses:
          type: integer
  source:
    code: "SELECT\n  DATE_TRUNC($granularity, \n    CASE \n      WHEN $timeField =\
      \ 'bl_est_date_d' THEN bl_est_date_d\n      WHEN $timeField = 'bl_exp_date_d'\
      \ THEN bl_exp_date_d\n      ELSE bl_est_date_d\n    END\n  ) as period,\n  COUNT(*)\
      \ as count,\n  COUNT(DISTINCT license_pk) as unique_licenses\nFROM dim_licenses\n\
      WHERE CASE \n    WHEN $timeField = 'bl_est_date_d' THEN bl_est_date_d\n    WHEN\
      \ $timeField = 'bl_exp_date_d' THEN bl_exp_date_d\n    ELSE bl_est_date_d\n\
      \  END IS NOT NULL\n  AND ($startDate IS NULL OR \n    CASE \n      WHEN $timeField\
      \ = 'bl_est_date_d' THEN bl_est_date_d\n      WHEN $timeField = 'bl_exp_date_d'\
      \ THEN bl_exp_date_d\n      ELSE bl_est_date_d\n    END >= $startDate::DATE)\n\
      \  AND ($endDate IS NULL OR \n    CASE \n      WHEN $timeField = 'bl_est_date_d'\
      \ THEN bl_est_date_d\n      WHEN $timeField = 'bl_exp_date_d' THEN bl_exp_date_d\n\
      \      ELSE bl_est_date_d\n    END <= $endDate::DATE)\nGROUP BY period\nORDER\
      \ BY period DESC"
  enabled: true
