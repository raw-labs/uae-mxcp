mxcp: 1.0.0
tool:
  name: "aggregate_licenses"
  description: "Aggregate UAE business licenses by any field(s) with deep filtering."
  tags: ["aggregate", "licenses", "uae", "deep-filters"]
  annotations:
    title: "Aggregate Licenses"
    readOnlyHint: true
    destructiveHint: false
    idempotentHint: true
    openWorldHint: false
  parameters:
    - { name: "group_by", type: "string", description: "Comma-separated list of columns to group by (max 2)", default: null, examples: ["emirate_name_en,bl_status_en"] }
    - { name: "metrics", type: "string", description: "Comma-separated list of metrics: count,distinct_count", default: "count", examples: ["count,distinct_count"] }
    - { name: "emirate_name_en", type: "string", description: "Emirate (EN) exact match", default: null }
    - { name: "emirate_name_en_like", type: "string", description: "Emirate (EN) substring match", default: null }
    - { name: "emirate_name_ar", type: "string", description: "Emirate (AR) exact match", default: null }
    - { name: "emirate_name_ar_like", type: "string", description: "Emirate (AR) substring match", default: null }
    - { name: "issuance_authority_en", type: "string", description: "Issuance authority (EN) exact match", default: null }
    - { name: "issuance_authority_en_like", type: "string", description: "Issuance authority (EN) substring match", default: null }
    - { name: "issuance_authority_ar", type: "string", description: "Issuance authority (AR) exact match", default: null }
    - { name: "issuance_authority_ar_like", type: "string", description: "Issuance authority (AR) substring match", default: null }
    - { name: "bl", type: "string", description: "License number exact match", default: null }
    - { name: "bl_like", type: "string", description: "License number substring match", default: null }
    - { name: "bl_status_en", type: "string", description: "License status (EN)", default: null }
    - { name: "bl_type_en", type: "string", description: "License type (EN)", default: null }
    - { name: "bl_legal_type_en", type: "string", description: "Legal type (EN)", default: null }
    - { name: "owner_nationality_en", type: "string", description: "Owner nationality (EN)", default: null }
    - { name: "relationship_type_en", type: "string", description: "Relationship type (EN)", default: null }
    - { name: "bl_est_date_d_from", type: "string", description: "Establishment date from (YYYY-MM-DD)", default: null }
    - { name: "bl_est_date_d_to", type: "string", description: "Establishment date to (YYYY-MM-DD)", default: null }
    - { name: "bl_exp_date_d_from", type: "string", description: "Expiry date from (YYYY-MM-DD)", default: null }
    - { name: "bl_exp_date_d_to", type: "string", description: "Expiry date to (YYYY-MM-DD)", default: null }
    - { name: "page_size", type: "integer", description: "Number of records per page", default: 20, minimum: 1, maximum: 1000 }
    - { name: "page", type: "integer", description: "Page number (1-based)", default: 1, minimum: 1 }
  return:
    type: array
    items:
      type: object
      properties:
        group_1: { type: string }
        group_2: { type: string }
        count: { type: integer }
        distinct_count: { type: integer }
  source:
    file: "aggregate_licenses.sql"
  enabled: true
  # tests:
  #   - name: "basic"
  #     arguments:
  #       - { key: "group_by", value: "emirate_name_en" }
  #       - { key: "metrics", value: "count" }
  #       - { key: "emirate_name_en", value: "Dubai" }
  #       - { key: "page_size", value: 1 }
  #     result: ">= 1 row"
  policies:
    output:
      - condition: "user.role == 'guest'"
        action: deny
        reason: "Guest users cannot aggregate by sensitive fields"
        fields: [
          # Personal Information
          "owner_nationality_en",
          "owner_gender",
          # Business Information
          "bl_name_en",
          "bl_cbls",
          "business_activity_code",
          # Relationship Information
          "relationship_type_en",
          "parent_licence_license_number",
          "parent_license_issuance_authority_en"
        ]
      - condition: "user.role == 'guest' && (group_by in ['owner_nationality_en', 'owner_gender', 'bl_name_en', 'bl_cbls', 'business_activity_code', 'relationship_type_en', 'parent_licence_license_number', 'parent_license_issuance_authority_en'])"
        action: deny
        reason: "Guest users cannot aggregate by sensitive information" 