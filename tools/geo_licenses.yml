mxcp: 1.0.0
tool:
  name: geo_licenses
  description: Analyze licenses by geographic location
  parameters:
  - name: groupByField
    type: string
    description: Geographic field to group by
    enum:
    - bl_full_address
    default: bl_full_address
  - name: includeCoordinates
    type: boolean
    description: Include lat/lon statistics
    default: false
  return:
    type: array
    items:
      type: object
      properties:
        location:
          type: string
        count:
          type: integer
        unique_licenses:
          type: integer
        avg_latitude:
          type: number
        avg_longitude:
          type: number
  source:
    code: "SELECT\n  CASE \n    WHEN $groupByField = 'emirate_name_en' THEN emirate_name_en\n\
      \    WHEN $groupByField = 'emirate_name_ar' THEN emirate_name_ar\n    WHEN $groupByField\
      \ = 'issuance_authority_en' THEN issuance_authority_en\n    WHEN $groupByField\
      \ = 'issuance_authority_ar' THEN issuance_authority_ar\n    ELSE emirate_name_en\n\
      \  END as location,\n  COUNT(*) as count,\n  COUNT(DISTINCT license_pk) as unique_licenses,\n\
      \  CASE \n    WHEN $includeCoordinates THEN AVG(CAST(lat_dd AS FLOAT))\n   \
      \ ELSE NULL\n  END as avg_latitude,\n  CASE \n    WHEN $includeCoordinates THEN\
      \ AVG(CAST(lon_dd AS FLOAT))\n    ELSE NULL\n  END as avg_longitude\nFROM dim_licenses\n\
      WHERE CASE \n    WHEN $groupByField = 'emirate_name_en' THEN emirate_name_en\n\
      \    WHEN $groupByField = 'emirate_name_ar' THEN emirate_name_ar\n    WHEN $groupByField\
      \ = 'issuance_authority_en' THEN issuance_authority_en\n    WHEN $groupByField\
      \ = 'issuance_authority_ar' THEN issuance_authority_ar\n    ELSE emirate_name_en\n\
      \  END IS NOT NULL\nGROUP BY location\nORDER BY count DESC"
  enabled: true
