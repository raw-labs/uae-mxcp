mxcp: 1.0.0
tool:
  name: geo_licenses
  description: Analyze licenses by geographic location
  parameters:
  - name: groupByField
    type: string
    description: Geographic field to group by
    enum:
    - bl_full_address
    default: bl_full_address
  - name: includeCoordinates
    type: boolean
    description: Include lat/lon statistics
    default: false
  - name: boundingBox
    type: object
    description: Filter by bounding box coordinates
    properties:
      minLat:
        type: number
      maxLat:
        type: number
      minLon:
        type: number
      maxLon:
        type: number
  - name: filterLicensePk
    type: string
    description: Filter by LicensePk
  - name: filterBl
    type: string
    description: Filter by Bl
  - name: filterCbls
    type: string
    description: Filter by Cbls
  - name: filterEmirateNameEn
    type: string
    description: Filter by EmirateNameEn
  - name: filterEmirateNameAr
    type: string
    description: Filter by EmirateNameAr
  - name: filterIssuanceAuthorityEn
    type: string
    description: Filter by IssuanceAuthorityEn
  - name: filterIssuanceAuthorityAr
    type: string
    description: Filter by IssuanceAuthorityAr
  - name: filterIssuanceAuthorityBranchEn
    type: string
    description: Filter by IssuanceAuthorityBranchEn
  - name: filterIssuanceAuthorityBranchAr
    type: string
    description: Filter by IssuanceAuthorityBranchAr
  - name: filterStatusEn
    type: string
    description: Filter by StatusEn
  - name: EstDateFrom
    type: string
    format: date
    description: Filter EstDate from date (YYYY-MM-DD)
  - name: EstDateTo
    type: string
    format: date
    description: Filter EstDate to date (YYYY-MM-DD)
  - name: ExpDateFrom
    type: string
    format: date
    description: Filter ExpDate from date (YYYY-MM-DD)
  - name: ExpDateTo
    type: string
    format: date
    description: Filter ExpDate to date (YYYY-MM-DD)
  return:
    type: array
    items:
      type: object
      properties:
        location:
          type: string
        count:
          type: integer
        unique_licenses:
          type: integer
        avg_latitude:
          type: number
        avg_longitude:
          type: number
        min_latitude:
          type: number
        max_latitude:
          type: number
        min_longitude:
          type: number
        max_longitude:
          type: number
  source:
    code: "SELECT\n  CASE \n    WHEN $groupByField = 'emirate_name_en' THEN emirate_name_en\n\
      \    WHEN $groupByField = 'emirate_name_ar' THEN emirate_name_ar\n    WHEN $groupByField\
      \ = 'issuance_authority_en' THEN issuance_authority_en\n    WHEN $groupByField\
      \ = 'issuance_authority_ar' THEN issuance_authority_ar\n    WHEN $groupByField\
      \ = 'bl_full_address' THEN bl_full_address\n    ELSE emirate_name_en\n  END\
      \ as location,\n  COUNT(*) as count,\n  COUNT(DISTINCT license_pk) as unique_licenses,\n\
      \  CASE \n    WHEN $includeCoordinates THEN AVG(lat_dd)\n    ELSE NULL\n  END\
      \ as avg_latitude,\n  CASE \n    WHEN $includeCoordinates THEN AVG(lon_dd)\n\
      \    ELSE NULL\n  END as avg_longitude,\n  CASE \n    WHEN $includeCoordinates\
      \ THEN MIN(lat_dd)\n    ELSE NULL\n  END as min_latitude,\n  CASE \n    WHEN\
      \ $includeCoordinates THEN MAX(lat_dd)\n    ELSE NULL\n  END as max_latitude,\n\
      \  CASE \n    WHEN $includeCoordinates THEN MIN(lon_dd)\n    ELSE NULL\n  END\
      \ as min_longitude,\n  CASE \n    WHEN $includeCoordinates THEN MAX(lon_dd)\n\
      \    ELSE NULL\n  END as max_longitude\nFROM dim_licenses_v1\nWHERE CASE \n\
      \    WHEN $groupByField = 'emirate_name_en' THEN emirate_name_en\n    WHEN $groupByField\
      \ = 'emirate_name_ar' THEN emirate_name_ar\n    WHEN $groupByField = 'issuance_authority_en'\
      \ THEN issuance_authority_en\n    WHEN $groupByField = 'issuance_authority_ar'\
      \ THEN issuance_authority_ar\n    WHEN $groupByField = 'bl_full_address' THEN\
      \ bl_full_address\n    ELSE emirate_name_en\n  END IS NOT NULL\n  AND ($filterLicensePk\
      \ IS NULL OR license_pk = $filterLicensePk)\n  AND ($filterBl IS NULL OR bl\
      \ = $filterBl)\n  AND ($filterCbls IS NULL OR bl_cbls = $filterCbls)\n  AND\
      \ ($filterEmirateNameEn IS NULL OR emirate_name_en = $filterEmirateNameEn)\n\
      \  AND ($filterEmirateNameAr IS NULL OR emirate_name_ar = $filterEmirateNameAr)\n\
      \  AND ($filterIssuanceAuthorityEn IS NULL OR issuance_authority_en = $filterIssuanceAuthorityEn)\n\
      \  AND ($filterIssuanceAuthorityAr IS NULL OR issuance_authority_ar = $filterIssuanceAuthorityAr)\n\
      \  AND ($filterIssuanceAuthorityBranchEn IS NULL OR issuance_authority_branch_en\
      \ = $filterIssuanceAuthorityBranchEn)\n  AND ($filterIssuanceAuthorityBranchAr\
      \ IS NULL OR issuance_authority_branch_ar = $filterIssuanceAuthorityBranchAr)\n\
      \  AND ($filterStatusEn IS NULL OR bl_status_en = $filterStatusEn)\n  AND ($EstDateFrom\
      \ IS NULL OR bl_est_date_d >= $EstDateFrom::DATE)\n  AND ($EstDateTo IS NULL\
      \ OR bl_est_date_d <= $EstDateTo::DATE)\n  AND ($ExpDateFrom IS NULL OR bl_exp_date_d\
      \ >= $ExpDateFrom::DATE)\n  AND ($ExpDateTo IS NULL OR bl_exp_date_d <= $ExpDateTo::DATE)\n\
      \  AND ($boundingBox.minLat IS NULL OR lat_dd >= $boundingBox.minLat)\n  AND\
      \ ($boundingBox.maxLat IS NULL OR lat_dd <= $boundingBox.maxLat)\n  AND ($boundingBox.minLon\
      \ IS NULL OR lon_dd >= $boundingBox.minLon)\n  AND ($boundingBox.maxLon IS NULL\
      \ OR lon_dd <= $boundingBox.maxLon)\nGROUP BY location\nORDER BY count DESC"
  enabled: true
